<!DOCTYPE html>
<html lang="id">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asesmen Figma Level C4</title>
    <!-- Memuat Tailwind CSS CDN untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            transition: all 0.3s ease;
        }
        /* Custom scrollbar untuk tampilan modern */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f3f4f6;
        }
    </style>
    <!-- Script konfigurasi Tailwind & Plugin -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'figma-blue': '#1a8cff',
                        'figma-dark': '#0f172a',
                        'figma-light': '#f8f8f8',
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<!-- Kontainer Utama Aplikasi -->
<!-- Catatan: Layar putih biasanya terjadi karena div#app kosong dan script belum sempat mengisi konten. -->
<div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-10 transition-all duration-500">
    <!-- Konten akan dimuat di sini oleh JavaScript -->
</div>

<!-- Firebase Script Imports (Hanya akan digunakan jika variabel lingkungan tersedia) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- VARIABEL GLOBAL FIREBASE & APP ---
    // Gunakan pengecekan keberadaan __app_id untuk menentukan apakah kita berada di lingkungan Canvas
    const isCanvasEnvironment = typeof __app_id !== 'undefined';
    
    // Variabel konfigurasi yang mungkin kosong jika dijalankan di lokal
    const appId = isCanvasEnvironment ? __app_id : 'asesmen-figma-default-id';
    const firebaseConfig = isCanvasEnvironment ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = isCanvasEnvironment ? __initial_auth_token : null;

    let db = null;
    let auth = null;
    let userId = null;

    // --- STATE APLIKASI ---
    let currentState = 'login'; // 'login', 'quiz', 'result'
    let currentQuestionIndex = 0;
    let score = 0;
    let quizData = [];
    let startTime = 0;
    let timerInterval = null;
    let quizDurationSeconds = 0; // Durasi dalam detik
    let userName = '';
    let userNIS = '';
    let isTabActive = true;

    // --- DATA SOAL C4 FIGMA (15 SOAL PILIHAN GANDA) ---
    const allQuestions = [
        {
            id: 1,
            question: "Anda diminta mendesain ulang antarmuka perangkat jam tangan pintar. Mengapa memilih Frame dengan Device Preset `Apple Watch 41mm` di Figma lebih efisien daripada membuat frame kustom dengan ukuran 368x448 px?",
            options: [
                "A. Device Preset secara otomatis menerapkan Constraints dan Auto Layout yang diperlukan untuk perangkat jam tangan.",
                "B. Device Preset memastikan adanya simulasi notch dan corner radius yang akurat, penting untuk prototipe beresolusi tinggi.",
                "C. Device Preset memungkinkan Anda menggunakan fitur Presentation View Figma dengan backdrop perangkat, memberikan konteks visual yang lebih otentik.",
                "D. Device Preset secara otomatis menambahkan library komponen Apple Watch ke file Figma Anda.",
            ],
            correctAnswer: "C", 
            topic: "Device Frame",
        },
        {
            id: 2,
            question: "Dalam konteks desain sistem, Anda memiliki Component 'Button' dasar. Bagaimana penambahan Variant 'Primary', 'Secondary', dan 'Disabled' secara efektif membantu analisis dan pemeliharaan desain?",
            options: [
                "A. Variant memungkinkan desainer mengganti fungsi tombol tanpa perlu memutus instance dari component utama.",
                "B. Variant mengisolasi setiap status tombol, memungkinkan perubahan global pada satu Component tanpa mempengaruhi struktur layer instance.",
                "C. Variant mengurangi jumlah Component yang harus dikelola di Assets Panel dan menjamin konsistensi pada tingkat properti.",
                "D. Variant secara otomatis menghasilkan dokumentasi kode CSS untuk setiap status tombol.",
            ],
            correctAnswer: "C", 
            topic: "Component & Variant",
        },
        {
            id: 3,
            question: "Seorang desainer prototipe e-commerce menggunakan Smart Animate untuk transisi antara halaman produk dan keranjang. Kapan penggunaan `Smart Animate` harus dipertimbangkan ulang dan diganti dengan `Instant` atau `Dissolve`?",
            options: [
                "A. Ketika elemen-elemen yang berpindah tidak memiliki nama layer yang identik di kedua Frame.",
                "B. Ketika transisi harus meniru perilaku sistem operasi yang tidak memiliki gerakan smooth (misalnya, notifikasi kesalahan).",
                "C. Ketika kedua Frame memiliki Auto Layout yang berbeda di level akar Frame.",
                "D. Ketika desainer ingin prototipe yang dihasilkan memuat lebih cepat di browser.",
            ],
            correctAnswer: "B", 
            topic: "Prototyping & Smart Animate",
        },
        {
            id: 4,
            question: "Anda harus membuat 50 tombol dengan 5 warna berbeda (Primary, Secondary, Success, Warning, Danger) yang masing-masing memiliki 3 status (Default, Hover, Disabled). Strategi Component/Variant mana yang paling efisien?",
            options: [
                "A. Buat 50 Component terpisah, satu untuk setiap kombinasi warna dan status.",
                "B. Buat satu Component induk 'Button', dan gunakan 5 Variant untuk Warna, lalu 3 Variant bersarang di dalamnya untuk Status.",
                "C. Buat satu Component 'Button' dengan dua properti Variant: `Color` (dengan 5 nilai) dan `State` (dengan 3 nilai).",
                "D. Buat 5 Component dasar berdasarkan warna, lalu duplikasi masing-masing Component 3 kali untuk status.",
            ],
            correctAnswer: "C", 
            topic: "Component & Variant",
        },
        {
            id: 5,
            question: "Mengapa menggunakan Linear Gradient pada Fill tombol (misalnya dari Biru Cerah ke Biru Tua) dianggap sebagai keputusan desain yang lebih baik untuk menarik perhatian dibandingkan hanya menggunakan Solid Fill?",
            options: [
                "A. Gradient secara otomatis meningkatkan rasio kontras warna tombol terhadap latar belakang, memenuhi standar aksesibilitas.",
                "B. Gradient menambahkan kedalaman visual dan kesan taktil ('terangkat') yang meniru efek pencahayaan pada objek 3D.",
                "C. Gradient lebih mudah diimplementasikan oleh pengembang web karena dapat diekspor langsung sebagai kode CSS `background-image: linear-gradient(...)`.",
                "D. Gradient memastikan warna tombol tetap konsisten di berbagai mode warna (RGB, HSL, CMYK) di Figma.",
            ],
            correctAnswer: "B", 
            topic: "Gradient & Styling",
        },
        {
            id: 6,
            question: "Saat mendesain alur pendaftaran, Anda menemukan bahwa pengguna sering keliru mengisi format tanggal. Bagaimana Prototyping dapat digunakan untuk menganalisis dan memvalidasi solusi tanpa harus membuat kode?",
            options: [
                "A. Gunakan tombol 'Submit' dengan interaksi Conditional yang memeriksa apakah Variabel Teks `inputTanggal` memiliki format YYYY-MM-DD.",
                "B. Buat simulasi pesan kesalahan dengan Delay 1 detik setelah input diisi, dan amati apakah pengguna menyadari kesalahan tersebut.",
                "C. Hubungkan input ke Frame yang menampilkan 'Picker Tanggal' (Date Picker) dan ukur seberapa cepat pengguna memilih tanggal.",
                "D. Lakukan pengujian di mana Anda memandu pengguna untuk sengaja mengisi format salah, dan amati seberapa jelas feedback error yang Anda buat.",
            ],
            correctAnswer: "D", 
            topic: "Prototyping & Validation",
        },
        {
            id: 7,
            question: "Anda memiliki Component utama 'Card' yang terdiri dari Auto Layout. Anda perlu membuat sebuah Variant 'Card/Small' yang memiliki padding 8px dan ukuran font lebih kecil. Perubahan apa yang akan terjadi pada instance 'Card/Small' jika Anda mengubah padding pada Component utama 'Card'?",
            options: [
                "A. Padding instance 'Card/Small' akan otomatis di-override dan kembali ke nilai 8px.",
                "B. Padding instance 'Card/Small' akan tetap 8px, karena Variant secara default mengunci properti yang sudah diubah.",
                "C. Padding instance 'Card/Small' akan berubah mengikuti Component utama, karena padding adalah properti struktural.",
                "D. Instance 'Card/Small' akan memunculkan peringatan konflik, meminta desainer untuk memilih properti mana yang harus dipertahankan.",
            ],
            correctAnswer: "B", 
            topic: "Component & Override",
        },
        {
            id: 8,
            question: "Dalam membuat Component 'Hamburger Menu Icon' yang dapat berubah menjadi 'Close Icon', mengapa menggunakan `Change To` (untuk Variant) lebih baik daripada menggunakan `Maps To` (untuk Frame lain)?",
            options: [
                "A. `Change To` mempertahankan posisi icon di halaman, sementara `Maps To` akan memuat ulang Frame.",
                "B. `Change To` memungkinkan transisi `Smart Animate` yang mulus antar state icon, yang tidak didukung oleh `Maps To`.",
                "C. `Change To` memproses interaksi lebih cepat karena tidak perlu memuat Frame baru.",
                "D. `Change To` adalah interaksi standar yang wajib digunakan ketika bekerja dengan Component Set.",
            ],
            correctAnswer: "B", 
            topic: "Prototyping & Variant",
        },
        {
            id: 9,
            question: "Anda menggunakan gradient pada latar belakang Frame. Mengapa penting untuk memastikan titik awal dan akhir gradient (stop points) diatur pada nilai persentase tertentu, dan bukan hanya warna acak?",
            options: [
                "A. Nilai persentase memastikan bahwa warna gradient akan beradaptasi dengan baik saat Frame di-resize di perangkat seluler.",
                "B. Titik persentase memungkinkan desainer menyalin persis kode warna untuk CSS di development hand-off.",
                "C. Persentase membantu desainer lain memahami distribusi warna dan memastikan gradient memiliki transisi yang konsisten.",
                "D. Persentase adalah satu-satunya cara untuk membuat gradient radial di Figma.",
            ],
            correctAnswer: "C", 
            topic: "Gradient & Styling",
        },
        {
            id: 10,
            question: "Anda membuat Component 'Form Input' yang memiliki tiga slot kosong: `Label`, `Text Input`, dan `Helper Text`. Agar desainer lain dapat dengan mudah menyembunyikan `Helper Text` tanpa memutus instance, fitur Figma manakah yang harus Anda terapkan pada Component utama?",
            options: [
                "A. Menggunakan `Boolean Property` (`Show Helper Text: true/false`) pada Variant.",
                "B. Menerapkan `Instance Swap Property` pada layer `Helper Text`.",
                "C. Menambahkan `Text Property` pada `Helper Text` dan mengosongkannya secara default.",
                "D. Mengubah `Helper Text` menjadi Component terpisah dan menggunakan `Preferred Values`.",
            ],
            correctAnswer: "A", 
            topic: "Component Properties",
        },
        {
            id: 11,
            question: "Anda sedang menganalisis performa prototipe. Jika transisi antar Frame terasa lambat dan patah-patah (laggy), penyebab paling mungkin adalah:",
            options: [
                "A. Penggunaan terlalu banyak `Interaction Details` (misalnya, On Drag) di satu Frame.",
                "B. Penggunaan terlalu banyak gambar beresolusi tinggi di Frame yang ditransisikan.",
                "C. Penggunaan `Smart Animate` pada dua Frame yang memiliki lapisan layer yang sangat kompleks (ratusan layer).",
                "D. Konflik antara `Fixed Position` element dengan Frame yang memiliki *Overflow Scrolling*.",
            ],
            correctAnswer: "C", 
            topic: "Prototyping Performance",
        },
        {
            id: 12,
            question: "Desainer B menggunakan Component A yang dibuat Desainer A. Desainer A mengubah nama lapisan dari 'Icon' menjadi 'Vector'. Apa konsekuensinya pada Desainer B jika mereka telah melakukan override pada warna 'Icon' di instance mereka?",
            options: [
                "A. Override warna akan hilang, dan instance akan mengikuti warna Component utama dengan nama layer baru 'Vector'.",
                "B. Override warna akan dipertahankan, karena Figma hanya melacak ID lapisan, bukan nama lapisan.",
                "C. Override warna akan hilang, dan instance akan rusak (detached).",
                "D. Override warna akan tetap ada, tetapi Desainer B tidak dapat melakukan override tambahan pada lapisan tersebut.",
            ],
            correctAnswer: "A", 
            topic: "Component & Override",
        },
        {
            id: 13,
            question: "Untuk membuat ilusi pergerakan horizontal yang tak terbatas (misalnya, Carousel Produk), interaksi Prototyping mana yang paling Anda rekomendasikan untuk dianalisis?",
            options: [
                "A. `On Click` dengan `Move In` dan Loop.",
                "B. `On Drag` dengan `Smart Animate` yang dihubungkan ke Frame dengan posisi item yang sedikit bergeser.",
                "C. `After Delay` dengan `Smart Animate` yang mengarah ke Frame yang sama.",
                "D. `While Pressing` yang memicu perubahan Variant pada Carousel.",
            ],
            correctAnswer: "B", 
            topic: "Prototyping Scroll",
        },
        {
            id: 14,
            question: "Mengapa desainer disarankan untuk membuat *Style* (Color Style) untuk setiap warna yang digunakan dalam gradient tombol daripada mengatur warna gradient secara langsung di Fill?",
            options: [
                "A. Color Style memungkinkan Anda mengganti semua warna gradient di seluruh file hanya dengan satu kali klik.",
                "B. Color Style dapat digunakan sebagai Variable untuk Conditional Logic di prototipe.",
                "C. Style memastikan bahwa setiap warna dalam gradient memiliki nama yang jelas, memfasilitasi komunikasi design-to-code.",
                "D. Style secara otomatis akan membuat gradient menjadi responsive terhadap perubahan ukuran Frame.",
            ],
            correctAnswer: "C", 
            topic: "Styling & Color Styles",
        },
        {
            id: 15,
            question: "Dalam membuat Component Input Field, Anda menerapkan Auto Layout. Jika Anda menetapkan jarak horizontal antar item menjadi `Space between`, dan mengubah padding vertikal menjadi `12px` di Component utama, konsekuensi terburuk apa yang mungkin terjadi pada instance Component tersebut?",
            options: [
                "A. Instance akan kehilangan kemampuan untuk menerima *text override*.",
                "B. Semua instance akan *detach* karena perubahan pada properti Auto Layout bersifat destruktif.",
                "C. Instance dapat menghasilkan *Cumulative Layout Shift (CLS)* yang buruk saat di-render di browser.",
                "D. Instance akan mempertahankan padding vertikalnya jika desainer sebelumnya telah menimpa nilai padding tersebut (local override).",
            ],
            correctAnswer: "D", 
            topic: "Auto Layout & Component",
        },
    ];

    // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
    async function initializeFirebase() {
        // PERBAIKAN UTAMA: Jika tidak ada config Firebase, lewati inisialisasi dan langsung render.
        if (!isCanvasEnvironment || !firebaseConfig) {
            console.warn("Firebase Config tidak ditemukan. Berjalan dalam mode lokal tanpa penyimpanan data (Firestore).");
            // Langsung render aplikasi ke halaman login
            renderApp(); 
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication logic
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase initialized. User ID:", userId);
                } else {
                    userId = null;
                    console.log("User not signed in.");
                }
                // Render aplikasi setelah status auth dicek
                renderApp(); 
            });
        } catch (error) {
            console.error("Gagal inisialisasi Firebase. Menonaktifkan persistence.", error);
            // Fallback: Pastikan aplikasi tetap berjalan meskipun Firebase gagal
            renderApp();
        }
    }

    // --- UTILITAS ---

    /** Fungsi untuk mengocok array (Fisher-Yates) */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    /** Fungsi untuk mengkonversi detik ke format MM:SS */
    function formatDuration(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = Math.floor(seconds % 60);
        const pad = (num) => num.toString().padStart(2, '0');
        return `${pad(minutes)}:${pad(remainingSeconds)}`;
    }

    // --- LOGIKA ANTI-CURANG (INACTIVITY) ---
    function handleVisibilityChange() {
        if (currentState === 'quiz') {
            if (document.visibilityState === 'hidden') {
                isTabActive = false;
                pauseTimer();
                console.warn("Tab kehilangan fokus. Inactivity logout dipicu!");
                // Langsung logout dan reset untuk mencegah kecurangan
                resetQuiz();
                navigateTo('login', 'Sesi direset. Anda meninggalkan tab saat asesmen berlangsung.');
            } else {
                isTabActive = true;
            }
        }
    }

    // --- LOGIKA TIMER ---
    function startTimer() {
        startTime = Date.now();
        quizDurationSeconds = 0;
        if (timerInterval) clearInterval(timerInterval);

        timerInterval = setInterval(() => {
            if (isTabActive) {
                quizDurationSeconds = Math.floor((Date.now() - startTime) / 1000);
                const timerElement = document.getElementById('timer');
                if (timerElement) {
                    timerElement.textContent = formatDuration(quizDurationSeconds);
                }
            }
        }, 1000);
    }

    function pauseTimer() {
        if (timerInterval) clearInterval(timerInterval);
    }

    // --- LOGIKA NAVIGASI & STATE ---
    function navigateTo(state, message = '') {
        currentState = state;
        renderApp(message);
    }

    function resetQuiz() {
        pauseTimer();
        currentQuestionIndex = 0;
        score = 0;
        quizDurationSeconds = 0;
        quizData = [];
    }

    // --- LOGIKA QUIZ ---
    function startQuiz() {
        // Ambil 15 soal dan acak urutannya
        quizData = shuffleArray([...allQuestions]).slice(0, 15);
        currentQuestionIndex = 0;
        score = 0;
        startTimer();
        navigateTo('quiz');
    }

    function handleAnswer(selectedOption) {
        if (currentQuestionIndex >= quizData.length) return;

        const currentQuestion = quizData[currentQuestionIndex];
        const isCorrect = selectedOption === currentQuestion.correctAnswer;

        if (isCorrect) {
            score++;
        }

        // Tandai jawaban yang dipilih untuk mencegah perubahan
        quizData[currentQuestionIndex].selectedAnswer = selectedOption;

        // Pindah ke soal berikutnya
        setTimeout(() => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizData.length) {
                renderApp();
            } else {
                submitQuiz();
            }
        }, 100); 
    }

    async function submitQuiz() {
        pauseTimer();

        // Hanya coba simpan ke Firestore jika db tersedia
        if (db && userId) {
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/asesmen_figma`, crypto.randomUUID());

                await setDoc(docRef, {
                    nama: userName,
                    nis: userNIS,
                    score: score,
                    totalQuestions: quizData.length,
                    durationSeconds: quizDurationSeconds,
                    durationFormatted: formatDuration(quizDurationSeconds),
                    timestamp: serverTimestamp(),
                    quizAttempt: quizData.map(q => ({
                        id: q.id,
                        selected: q.selectedAnswer,
                        correct: q.correctAnswer
                    }))
                });
                console.log("Hasil asesmen berhasil disimpan ke Firestore.");
            } catch (e) {
                console.error("Gagal menyimpan hasil asesmen ke Firestore:", e);
            }
        } else {
            console.warn("Firestore dinonaktifkan (mode lokal). Hasil tidak disimpan.");
        }

        navigateTo('result');
    }

    // --- KOMPONEN RENDER (Tidak ada perubahan di sini) ---
    // ... (renderLoginScreen, renderQuizScreen, renderResultScreen tetap sama) ...
    function renderLoginScreen(message) {
        return `
            <div class="flex flex-col items-center justify-center p-8 bg-figma-light rounded-lg shadow-xl border-t-4 border-figma-blue">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-figma-blue mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm0 13a5 5 0 1 1 0-10 5 5 0 0 1 0 10zM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg>
                <h1 class="text-3xl font-bold text-figma-dark mb-2">Asesmen C4 Figma</h1>
                <p class="text-sm text-gray-500 mb-6 text-center">Analisis & Evaluasi Konsep Desain Sistem</p>

                ${message ? `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg w-full text-sm" role="alert">${message}</div>` : ''}

                <div class="w-full space-y-4">
                    <input id="inputName" type="text" placeholder="Nama Lengkap" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-figma-blue" value="${userName}">
                    <input id="inputNIS" type="text" placeholder="NIS (Nomor Induk Siswa)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-figma-blue" value="${userNIS}">
                    <button id="btnLogin" class="w-full p-3 bg-figma-blue hover:bg-blue-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">
                        Mulai Asesmen (15 Soal)
                    </button>
                </div>
            </div>
        `;
    }

    function renderQuizScreen() {
        const totalQuestions = quizData.length;
        const question = quizData[currentQuestionIndex];
        const progress = Math.round(((currentQuestionIndex) / totalQuestions) * 100);

        return `
            <div class="flex flex-col h-full">
                <!-- Header Status & Timer -->
                <div class="flex justify-between items-center pb-4 border-b border-gray-200 mb-6 sticky top-0 bg-white pt-2 z-10">
                    <h2 class="text-xl font-bold text-figma-dark">${userName} (${userNIS})</h2>
                    <div class="flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Durasi:</span>
                        <div id="timer" class="text-xl font-mono font-bold text-figma-blue">00:00</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mb-6">
                    <p class="text-sm text-gray-600 mb-2">Soal ${currentQuestionIndex + 1} dari ${totalQuestions}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-figma-blue h-2.5 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                    </div>
                </div>

                <!-- Konten Soal -->
                <div class="flex-grow custom-scrollbar overflow-y-auto pr-2">
                    <div class="bg-figma-light p-5 rounded-xl shadow-inner">
                        <p class="text-lg font-semibold text-gray-800 leading-relaxed">${question.question}</p>
                    </div>

                    <!-- Pilihan Jawaban -->
                    <div id="optionsContainer" class="mt-6 space-y-4">
                        ${question.options.map((option, index) => {
                            const optionLetter = String.fromCharCode(65 + index); // A, B, C, D
                            const isSelected = question.selectedAnswer === optionLetter;
                            const optionClasses = `
                                flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all duration-150
                                ${isSelected
                                    ? 'bg-figma-blue text-white border-figma-blue shadow-lg scale-[1.01]'
                                    : 'bg-white border-gray-300 hover:border-figma-blue hover:shadow-md'
                                }
                            `;
                            const textClasses = isSelected ? 'font-semibold' : 'text-gray-700';

                            return `
                                <div data-answer="${optionLetter}" class="${optionClasses}">
                                    <div class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center mr-4 
                                        ${isSelected ? 'bg-white text-figma-blue font-bold' : 'bg-gray-100 text-gray-500 border border-gray-300 font-medium'}">
                                        ${optionLetter}
                                    </div>
                                    <p class="${textClasses} text-base">${option.substring(3)}</p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>

                <!-- Footer Navigasi -->
                <div class="pt-6 border-t border-gray-200 mt-6 flex justify-end">
                    <button id="btnNext" class="px-6 py-3 bg-figma-blue hover:bg-blue-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200"
                        ${currentQuestionIndex === totalQuestions - 1 ? 'data-action="submit"' : 'data-action="next"'}>
                        ${currentQuestionIndex === totalQuestions - 1 ? 'Selesai & Kumpulkan' : 'Soal Berikutnya'}
                    </button>
                </div>
            </div>
        `;
    }

    function renderResultScreen() {
        const isPassed = score >= Math.ceil(quizData.length * 0.7); // Contoh kelulusan 70%
        const scorePercentage = (score / quizData.length) * 100;
        const persistenceStatus = db ? 'Data tersimpan ke Firestore.' : 'Mode lokal: Data TIDAK disimpan.';

        return `
            <div class="flex flex-col items-center justify-center p-8 bg-figma-light rounded-lg shadow-xl border-t-4 ${isPassed ? 'border-green-500' : 'border-red-500'}">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 ${isPassed ? 'text-green-500' : 'text-red-500'} mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><path d="M22 4L12 14.01l-3-3"></path></svg>
                
                <h1 class="text-3xl font-bold text-figma-dark mb-4">${isPassed ? 'Selamat, Asesmen Selesai!' : 'Asesmen Selesai!'}</h1>
                
                <div class="w-full max-w-sm bg-white p-6 rounded-lg shadow-inner space-y-3 mb-6">
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">Nama Siswa:</span>
                        <span class="font-semibold text-gray-800">${userName}</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">NIS:</span>
                        <span class="font-semibold text-gray-800">${userNIS}</span>
                    </div>
                    <div class="flex justify-between border-b pb-2">
                        <span class="text-gray-600">Durasi Pengerjaan:</span>
                        <span class="font-semibold text-figma-blue">${formatDuration(quizDurationSeconds)}</span>
                    </div>
                    <div class="flex justify-between pt-2">
                        <span class="text-lg font-bold">Skor Akhir:</span>
                        <span class="text-2xl font-bold ${isPassed ? 'text-green-600' : 'text-red-600'}">${score} / ${quizData.length} (${scorePercentage.toFixed(0)}%)</span>
                    </div>
                </div>

                <p class="text-sm text-gray-500 mb-4">${persistenceStatus}</p>

                <button id="btnTryAgain" class="px-6 py-3 bg-figma-blue hover:bg-blue-600 text-white font-semibold rounded-lg shadow-md transition-colors duration-200">
                    Selesai & Keluar
                </button>
            </div>
        `;
    }

    // --- RENDER UTAMA APLIKASI ---
    function renderApp(message = '') {
        const appContainer = document.getElementById('app');
        if (!appContainer) return;

        // Clear previous event listeners to prevent memory leaks/multiple triggers
        appContainer.innerHTML = '';
        appContainer.className = 'w-full max-w-4xl bg-white shadow-2xl rounded-xl p-6 sm:p-10 transition-all duration-500';

        let htmlContent = '';
        switch (currentState) {
            case 'login':
                htmlContent = renderLoginScreen(message);
                break;
            case 'quiz':
                htmlContent = renderQuizScreen();
                break;
            case 'result':
                htmlContent = renderResultScreen();
                break;
            default:
                htmlContent = renderLoginScreen('Error: Status aplikasi tidak valid. Harap mulai ulang.');
        }

        appContainer.innerHTML = htmlContent;
        attachEventListeners();
    }

    // --- ATTACH EVENT LISTENERS (Dipanggil setelah render) ---
    function attachEventListeners() {
        switch (currentState) {
            case 'login':
                document.getElementById('btnLogin')?.addEventListener('click', () => {
                    const inputName = document.getElementById('inputName').value.trim();
                    const inputNIS = document.getElementById('inputNIS').value.trim();

                    if (inputName && inputNIS) {
                        userName = inputName;
                        userNIS = inputNIS;
                        startQuiz();
                    } else {
                        renderApp('Harap isi Nama Lengkap dan NIS untuk memulai asesmen.');
                    }
                });
                break;

            case 'quiz':
                // Listener untuk pilihan jawaban
                const optionsContainer = document.getElementById('optionsContainer');
                if (optionsContainer) {
                    optionsContainer.addEventListener('click', (event) => {
                        let target = event.target.closest('[data-answer]');
                        if (target) {
                             // Nonaktifkan semua opsi setelah satu dipilih
                            Array.from(optionsContainer.children).forEach(child => {
                                child.classList.remove('cursor-pointer', 'hover:border-figma-blue', 'hover:shadow-md');
                            });
                            handleAnswer(target.getAttribute('data-answer'));
                        }
                    });
                }

                // Listener untuk tombol Next/Submit
                document.getElementById('btnNext')?.addEventListener('click', (event) => {
                    // Tindakan ini sekarang hanya berfungsi sebagai tombol visual,
                    // karena logika pindah soal sudah dihandle oleh handleAnswer().
                    // Namun, kita tetap mempertahankan logikanya di sini untuk submit terakhir.
                    const action = event.target.getAttribute('data-action');
                    if (action === 'submit') {
                        submitQuiz();
                    } 
                });
                break;

            case 'result':
                document.getElementById('btnTryAgain')?.addEventListener('click', () => {
                    resetQuiz();
                    navigateTo('login');
                });
                break;
        }
    }

    // --- SETUP AWAL ---
    document.addEventListener('DOMContentLoaded', () => {
        // Init Firebase (akan di-bypass jika dijalankan lokal)
        initializeFirebase();

        // Setup Inactivity/Tab Blur Listener (Anti-Curang)
        document.addEventListener('visibilitychange', handleVisibilityChange);
    });
</script>
